# Pagila

> This fork is based on **[Pagila](https://github.com/devrimgunduz/pagila) version 3.1.0**. Pagila has been tested against **PostgreSQL 12 and above**.

## About this Fork

This fork of the Pagila database focuses on streamlining the installation process and improving overall usability. Several enhancements have been made to simplify setup and clarify structure.

### Overview of Changes

- Files are now grouped by purpose, resulting in a **cleaner directory layout**.

- The default PostgreSQL user has been changed from `postgres` to `javosw`. As a result, all SQL objects are now owned by `javosw`.

- The `docker-compose.yml` file has been updated with the following changes:
  - The database name is now explicitly set to `pagila`.
  - Exposed ports have been adjusted to avoid conflicts with existing local PostgreSQL installations.

- The `README.md` has been revised to include:
  - Clearer setup and installation instructions.
  - Links to solved querying problems on Sakila for practice and learning.

- A **high-resolution entity-relationship diagram** was added under the `docs/` directory.

## Create the database

### Using Docker

1. **Create the database**:

    ```bash
    docker pull postgres:17.5
    
    docker run --name pagila \
      -e POSTGRES_USER=javosw \
      -e POSTGRES_PASSWORD=122333 \
      -e POSTGRES_DB=pagila \
      -p 5401:5432 \
      -d postgres:17.5
    ```

2. **Create all schema objects** (tables, etc):

    ```bash
    docker exec -i pagila psql -U javosw -d pagila < ./sql/main/pagila-schema.sql
    ```

3. **Insert all data**:

    ```bash
    docker exec -i pagila psql -U javosw -d pagila < ./sql/main/pagila-data.sql
    ```

### Using Docker Compose

1. **Run**:

    ```bash
    docker compose up
    ```

## **Enter the database**

**Option 1**:

```bash
docker exec -it pagila psql -U javosw -d pagila
```

**Option 2**:

```bash
psql -h localhost -p 5401 -U javosw -d pagila
```

**Done!** You're in.

```plaintext
psql (17.5 (Debian 17.5-1.pgdg120+1))
Type "help" for help.

pagila=#
```

## Installation notes

### Loading Data Files

The `pagila-data.sql` and `pagila-insert-data.sql` files contain the same dataset, but differ in how they load the data:

- **`pagila-data.sql`** uses `COPY` commands — **faster** loading.
- **`pagila-insert-data.sql`** uses `INSERT` statements — **slower** loading.

You only need to use **one** of these files. You can load either file using `psql`.

Both options are provided:

- To support users who may have issues with one format.
- For instructors who want to demonstrate the performance difference between `COPY` and `INSERT`.

### Loading JSONB Files

The JSONB version of the dataset is divided into:

- **Schema** (plain SQL — use `psql` to load):
  - `sql/dump/pagila-schema-jsonb.sql`

- **Data** (custom-format binary dumps — use `pg_restore` to load):
  - `sql/dump/pagila-data-yum-jsonb.sql`
  - `sql/dump/pagila-data-apt-jsonb.sql`
  - `sql/dump/pagila-insert-data_yum-jsonb.sql`
  - `sql/dump/pagila-insert-data_apt-jsonb.sql`
  > These **JSONB data files** were exported using `pg_dump --format=custom` to reduce repository size.

```bash
# schema
docker exec -i pagila psql -U javosw -d pagila < ./sql/dump/pagila-schema-jsonb.sql
# data
docker exec -i pagila pg_restore --no-owner -U javosw -d pagila < ./sql/dump/pagila-data-apt-jsonb.sql
```

## pgAdmin

pgAdmin is included in the `docker-compose.yml`.

Navigate to the URL: [`http://localhost:5402/`](http://localhost:5402/)

- Default Username: `admin@admin.com`
- Default Password: `122333`

## Sample query

```sql
-- total revenue generated by each film category
WITH
  cte_revenue_by_film_category AS (
    SELECT
      film_category.category_id,
      SUM(payment.amount) AS total_revenue
    FROM
      film_category
      JOIN film ON film.film_id = film_category.film_id
      JOIN inventory ON inventory.film_id = film.film_id
      JOIN rental ON rental.inventory_id = inventory.inventory_id
      JOIN payment ON payment.rental_id = rental.rental_id
      JOIN category ON category.category_id = film_category.category_id
    GROUP BY
      film_category.category_id
  )
SELECT
  category.name AS category_name,
  cte.total_revenue
FROM
  cte_revenue_by_film_category AS cte
  JOIN category ON category.category_id = cte.category_id
ORDER BY
  cte.total_revenue DESC;
```

## Data Querying Problems

- [Problem Set 1](https://github.com/vanessacrramos/SQL-Case-Study-Sakila)
- [Problem Set 2](https://github.com/Ragijaireddy/sakila_DB-sql-query-examples)
