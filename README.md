# Pagila

> This fork is based on **[Pagila](https://github.com/devrimgunduz/pagila) version 3.1.0**. Pagila has been tested against **PostgreSQL 12 and above**.

## About this Fork

This fork of the Pagila database focuses on streamlining the installation process and improving overall usability. Several enhancements have been made to simplify setup and clarify structure.

### Key Improvements

- **Organized File Structure**  
  Files are now grouped by purpose, resulting in a cleaner and more maintainable directory layout.

- **PostgreSQL User Change**  
  The default PostgreSQL user has been changed from `postgres` to `javosw`.  
  - As a result, all SQL objects are now owned by `javosw`.
  > Note: You may need to update ownership manually if your environment relies on the default `postgres` user.

- **Docker Configuration Updates**  
  The `docker-compose.yml` file has been updated with the following changes:
  - The database name is now explicitly set to `pagila`.
  - Exposed ports have been adjusted to avoid conflicts with existing local PostgreSQL installations.

- **Improved Documentation**  
  The `README.md` has been revised to include:
  - Clearer setup and installation instructions.
  - Suggestions for common data querying tasks and challenges.

- **Enhanced ER Diagram**  
  A high-resolution entity-relationship diagram is now available for reference under the `docs/` directory.

## Create the database

### Using Docker
1. **Create the database**:

```bash
docker pull postgres:17.5

docker run --name pagila \
  -e POSTGRES_USER=javosw \
  -e POSTGRES_PASSWORD=122333 \
  -e POSTGRES_DB=pagila \
  -p 5401:5432 \
  -d postgres:17.5
```

2. **Create all schema objects** (tables, etc):

```bash
docker exec -i pagila psql -U javosw -d pagila < ./sql/main/pagila-schema.sql
```

3. **Insert all data**:

```bash
docker exec -i pagila psql -U javosw -d pagila < ./sql/main/pagila-data.sql
```

### Using Docker Compose

1. **Run**:

```bash
docker compose up
```

## **Enter the database**

**Option 1**:
```bash
docker exec -it pagila psql -U javosw -d pagila
```

**Option 2**:
```bash
psql -h localhost -p 5401 -U javosw -d pagila
```

**Done!** You're in.
```
psql (17.5 (Debian 17.5-1.pgdg120+1))
Type "help" for help.

pagila=#
```

## Installation notes

### Loading Data Files
The `pagila-data.sql` file and the `pagila-insert-data.sql` both contain the same data, the former using `COPY` commands (**faster** for bulk loading), the latter using `INSERT` commands (**slower**), so **you only need to install one of them**. Both formats are provided for those who have trouble using one version or another, and for instructors who want to point out the longer data loading time with the latter. You can load them via `psql`.

### Loading JSONB Files
* Schema (plain SQL):
  * `sql/dump/pagila-schema-jsonb.sql`

* Data (**binary dump**, not plain SQL):
  * `sql/dump/pagila-data-yum-jsonb.sql`
  * `sql/dump/pagila-data-apt-jsonb.sql`
  * `sql/dump/pagila-insert-data_yum-jsonb.sql`
  * `sql/dump/pagila-insert-data_apt-jsonb.sql`

JSONB dumps are large and complex. To reduce GitHub repo size and retain full structure, they were exported in **custom format** using `pg_dump --format=custom`.

Use `pg_restore` when the file is a **binary dump**. You can still use **`psql`** to load **`pagila-schema-jsonb.sql`**, **however** please **use `pg_restore` to load `jsonb` data files**:

```bash
docker exec -i pagila psql -U javosw -d pagila < ./sql/dump/pagila-schema-jsonb.sql

docker exec -i pagila pg_restore --no-owner -U javosw -d pagila < ./sql/dump/pagila-data-apt-jsonb.sql
```

## pgAdmin
pgAdmin is included in the `docker-compose.yml`.

Navigate to the URL: [`http://localhost:5402/`](http://localhost:5402/)
- Default Username: `admin@admin.com`
- Default Password: `122333`

## Sample query

```sql
-- total revenue generated by each film category
WITH
  cte_revenue_by_film_category AS (
    SELECT
      film_category.category_id,
      SUM(payment.amount) AS total_revenue
    FROM
      film_category
      JOIN film ON film.film_id = film_category.film_id
      JOIN inventory ON inventory.film_id = film.film_id
      JOIN rental ON rental.inventory_id = inventory.inventory_id
      JOIN payment ON payment.rental_id = rental.rental_id
      JOIN category ON category.category_id = film_category.category_id
    GROUP BY
      film_category.category_id
  )
SELECT
  category.name AS category_name,
  cte.total_revenue
FROM
  cte_revenue_by_film_category AS cte
  JOIN category ON category.category_id = cte.category_id
ORDER BY
  cte.total_revenue DESC;
```

## Data Querying Problems

- [Problem Set 1](https://github.com/vanessacrramos/SQL-Case-Study-Sakila)
- [Problem Set 2](https://github.com/Ragijaireddy/sakila_DB-sql-query-examples)



